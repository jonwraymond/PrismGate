# Sandbox Execution Strategy
# 3-tier execution for call_tool_chain: direct JSON, regex, full V8

direction: down

title: {
  label: call_tool_chain Execution Strategy
  near: top-center
  shape: text
  style: {
    font-size: 28
    bold: true
    font-color: "#1a1a2e"
  }
}

# --- Input ---
input: {
  label: |md
    **call_tool_chain(code, timeout, max_output_size)**
    Receives TypeScript/JSON code from Claude
  |
  shape: rectangle
  style: {
    fill: "#dbeafe"
    stroke: "#2563eb"
    border-radius: 10
    shadow: true
    font-size: 14
    bold: true
  }
}

# --- Tier 1 ---
tier1: {
  label: "Tier 1: Direct JSON Parsing"
  style: {
    fill: "#ecfdf5"
    stroke: "#10b981"
    border-radius: 12
    shadow: true
    font-size: 16
    bold: true
  }

  check: {
    label: |md
      **try_direct_tool_call() -- JSON path**
      Parse as `serde_json::from_str::<Value>()`
      Pattern: `{"tool": "backend.tool", "arguments": {...}}`
    |
    shape: rectangle
    style: {
      fill: "#d1fae5"
      stroke: "#059669"
      border-radius: 8
      font-size: 13
    }
  }

  perf: {
    label: |md
      **O(1) -- No V8, No semaphore**
      Zero overhead, instant dispatch
    |
    shape: rectangle
    style: {
      fill: "#a7f3d0"
      stroke: "#047857"
      border-radius: 6
      font-size: 12
      bold: true
    }
  }

  example: {
    label: |md
      ```json
      {"tool": "exa.web_search_exa",
       "arguments": {"query": "rust mcp"}}
      ```
    |
    shape: page
    style: {
      fill: "#f0fdf4"
      stroke: "#86efac"
      border-radius: 6
      font-size: 11
    }
  }
}

# --- Tier 2 ---
tier2: {
  label: "Tier 2: Simple TypeScript Regex"
  style: {
    fill: "#eff6ff"
    stroke: "#3b82f6"
    border-radius: 12
    shadow: true
    font-size: 16
    bold: true
  }

  check: {
    label: |md
      **try_direct_tool_call() -- regex path**
      Strip `const result = `, `await`, `return result;`
      Match pattern: `backend.tool({...})`
      Parse args with `serde_json::from_str()`
    |
    shape: rectangle
    style: {
      fill: "#dbeafe"
      stroke: "#2563eb"
      border-radius: 8
      font-size: 13
    }
  }

  perf: {
    label: |md
      **O(1) -- No V8, No semaphore**
      String operations only
    |
    shape: rectangle
    style: {
      fill: "#bfdbfe"
      stroke: "#3b82f6"
      border-radius: 6
      font-size: 12
      bold: true
    }
  }

  example: {
    label: |md
      ```typescript
      const result = await exa.web_search_exa(
        {"query": "rust mcp"}
      );
      return result;
      ```
    |
    shape: page
    style: {
      fill: "#eff6ff"
      stroke: "#93c5fd"
      border-radius: 6
      font-size: 11
    }
  }
}

# --- Tier 3 ---
tier3: {
  label: "Tier 3: Full V8 Sandbox"
  style: {
    fill: "#ede9fe"
    stroke: "#7c3aed"
    border-radius: 12
    shadow: true
    font-size: 16
    bold: true
  }

  acquire: {
    label: |md
      **Acquire sandbox semaphore**
      Limits concurrent V8 isolates
      (configurable: max_concurrent_sandboxes)
      Timeout = call's own timeout
    |
    shape: rectangle
    style: {
      fill: "#e9d5ff"
      stroke: "#8b5cf6"
      border-radius: 8
      font-size: 13
    }
  }

  example: {
    label: |md
      ```typescript
      const results = await exa.web_search_exa(
        {"query": "rust async"}
      );
      const urls = results.results.map(r => r.url);
      const details = [];
      for (const url of urls.slice(0, 3)) {
        details.push(
          await exa.get_contents({ids: [url]})
        );
      }
      return {results, details};
      ```
    |
    shape: page
    style: {
      fill: "#f5f3ff"
      stroke: "#a78bfa"
      border-radius: 6
      font-size: 11
    }
  }
}

# --- V8 Thread Architecture ---
v8_arch: {
  label: "V8 Thread Architecture"
  style: {
    fill: "#f8fafc"
    stroke: "#64748b"
    border-radius: 12
    shadow: true
    font-size: 16
    bold: true
  }

  tokio_rt: {
    label: |md
      **Main Tokio Runtime**
      - BackendManager (rmcp services)
      - Tool registry lookups
      - Network I/O (backend calls)
    |
    shape: rectangle
    style: {
      fill: "#e0f2fe"
      stroke: "#0284c7"
      border-radius: 8
      font-size: 12
    }
  }

  channel: {
    label: |md
      **oneshot channel**
      tx.send(result)
    |
    shape: queue
    style: {
      fill: "#fef3c7"
      stroke: "#d97706"
      border-radius: 6
      font-size: 12
    }
  }

  v8_thread: {
    label: |md
      **Dedicated V8 Thread**
      `std::thread::Builder::new("gatemini-sandbox")`
      - V8 isolate is !Send
      - rustyscript Runtime
      - 50MB heap limit (default)
      - Configurable timeout
    |
    shape: rectangle
    style: {
      fill: "#e9d5ff"
      stroke: "#8b5cf6"
      border-radius: 8
      font-size: 12
    }
  }

  tokio_rt -> v8_thread: "spawn thread" {
    style: { stroke: "#4b5563"; stroke-width: 2; font-size: 11 }
  }
  v8_thread -> tokio_rt: "Handle::spawn(__call_tool)" {
    style: { stroke: "#ea580c"; stroke-width: 2; font-size: 11 }
  }
  v8_thread -> channel: "result" {
    style: { stroke: "#d97706"; stroke-width: 2; font-size: 11 }
  }
  channel -> tokio_rt: "rx.await" {
    style: { stroke: "#d97706"; stroke-width: 2; font-size: 11 }
  }
}

# --- Bridge Preamble ---
preamble: {
  label: "Bridge Preamble (auto-generated per sandbox)"
  style: {
    fill: "#fff7ed"
    stroke: "#ea580c"
    border-radius: 12
    shadow: true
    font-size: 16
    bold: true
  }

  code: {
    label: "Auto-generated JavaScript:\n- __call_tool bridge function\n- Node.js shims (require, process, Buffer)\n- Per-backend accessor objects (exa, github, ...)\n- Introspection: __interfaces, __getToolInterface()"
    shape: page
    style: {
      fill: "#ffedd5"
      stroke: "#f97316"
      border-radius: 8
      font-size: 11
    }
  }
}

# --- Flow connections ---
input -> tier1: "try JSON parse" {
  style: { stroke: "#10b981"; stroke-width: 2; font-size: 12 }
}
tier1 -> tier2: "not JSON" {
  style: { stroke: "#dc2626"; stroke-width: 2; font-size: 12 }
}
tier2 -> tier3: "not simple pattern" {
  style: { stroke: "#dc2626"; stroke-width: 2; font-size: 12 }
}

dispatch: {
  label: "call_tool_by_dotted_name()\nResolve registry entry\ncall_tool_with_fallback()\nPasses original_name to backend"
  shape: rectangle
  style: {
    fill: "#d1fae5"
    stroke: "#059669"
    border-radius: 8
    font-size: 12
    bold: true
  }
}

tier1.check -> dispatch: "matched" {
  style: { stroke: "#059669"; stroke-width: 2; stroke-dash: 5; font-size: 11 }
}
tier2.check -> dispatch: "matched" {
  style: { stroke: "#059669"; stroke-width: 2; stroke-dash: 5; font-size: 11 }
}
tier3 -> v8_arch: "full sandbox execution" {
  style: { stroke: "#7c3aed"; stroke-width: 2; font-size: 12 }
}
