name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos-intel:
    name: Build macOS Intel
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - name: Build release binary
        run: |
          cargo build --locked --release --target x86_64-apple-darwin
      - name: Package artifact
        env:
          BINARY_PATH: target/x86_64-apple-darwin/release/gatemini
        run: |
          if [ ! -x "$BINARY_PATH" ]; then
            echo "Expected binary not found at $BINARY_PATH"
            ls -la target/x86_64-apple-darwin/release || true
            exit 1
          fi
          mkdir -p dist
          cp "$BINARY_PATH" dist/gatemini
          tar -czf "dist/gatemini-${GITHUB_REF_NAME}-darwin-x86_64.tar.gz" -C dist gatemini
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos-intel
          path: dist/*.tar.gz

  build-macos-silicon:
    name: Build macOS Apple Silicon
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - name: Build release binary
        run: |
          cargo build --locked --release --target aarch64-apple-darwin
      - name: Package artifact
        env:
          BINARY_PATH: target/aarch64-apple-darwin/release/gatemini
        run: |
          if [ ! -x "$BINARY_PATH" ]; then
            echo "Expected binary not found at $BINARY_PATH"
            ls -la target/aarch64-apple-darwin/release || true
            exit 1
          fi
          mkdir -p dist
          cp "$BINARY_PATH" dist/gatemini
          tar -czf "dist/gatemini-${GITHUB_REF_NAME}-darwin-arm64.tar.gz" -C dist gatemini
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-macos-silicon
          path: dist/*.tar.gz

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc
      - name: Build release binary
        run: |
          cargo build --locked --release --target x86_64-pc-windows-msvc
      - name: Package artifact
        shell: pwsh
        run: |
          $binaryPath = "target\\x86_64-pc-windows-msvc\\release\\gatemini.exe"
          if (-not (Test-Path $binaryPath)) {
            Write-Error "Expected binary not found at $binaryPath"
            exit 1
          }
          New-Item -ItemType Directory -Force dist | Out-Null
          Copy-Item $binaryPath -Destination "dist\gatemini.exe"
          Compress-Archive -Path "dist\gatemini.exe" -DestinationPath "dist\gatemini-${env:GITHUB_REF_NAME}-windows-x86_64.zip" -Force
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: dist\*.zip

  build-linux-packages:
    name: Build Linux + DEB + RPM
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-unknown-linux-gnu
      - name: Install package tooling
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm
          gem_user_bin="$(ruby -e 'puts Gem.user_dir')/bin"
          gem install --user-install --no-document fpm
          echo "GEM_BIN_DIR=$gem_user_bin" >> "$GITHUB_ENV"
          echo "$gem_user_bin" >> "$GITHUB_PATH"
      - name: Build release binary
        run: |
          cargo build --locked --release --target x86_64-unknown-linux-gnu
      - name: Package Linux artifacts
        id: package
        run: |
          set -euo pipefail
          FPM_BIN="${GEM_BIN_DIR}/fpm"

          if [ ! -x "$FPM_BIN" ]; then
            echo "fpm not found at $FPM_BIN"
            ls -la "${HOME}/.local/share/gem/bin" || true
            exit 1
          fi

          VERSION="${GITHUB_REF_NAME#v}"

          LINUX_BINARY="target/x86_64-unknown-linux-gnu/release/gatemini"
          if [ ! -x "$LINUX_BINARY" ]; then
            echo "Expected binary not found at $LINUX_BINARY"
            ls -la target/x86_64-unknown-linux-gnu/release || true
            exit 1
          fi

          mkdir -p dist
          cp "$LINUX_BINARY" dist/gatemini
          tar -czf "dist/gatemini-${GITHUB_REF_NAME}-linux-x86_64.tar.gz" -C dist gatemini

          mkdir -p pkg/usr/local/bin
          cp "$LINUX_BINARY" pkg/usr/local/bin/gatemini

          "$FPM_BIN" -s dir -t deb -n gatemini -v "$VERSION" --iteration 1 \
            --architecture amd64 \
            --description "MCP gateway that aggregates tools from multiple backend MCP servers" \
            --license Apache-2.0 \
            --maintainer "gatemini" \
            --url "https://github.com/${{ github.repository }}" \
            --package dist/gatemini_${VERSION}_amd64.deb \
            -C pkg .

          "$FPM_BIN" -s dir -t rpm -n gatemini -v "$VERSION" --iteration 1 \
            --architecture x86_64 \
            --description "MCP gateway that aggregates tools from multiple backend MCP servers" \
            --license Apache-2.0 \
            --maintainer "gatemini" \
            --url "https://github.com/${{ github.repository }}" \
            --package dist/gatemini-${VERSION}-1.x86_64.rpm \
            -C pkg .
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-linux
          path: dist/*

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    if: "!cancelled()"
    needs:
      - build-macos-intel
      - build-macos-silicon
      - build-windows
      - build-linux-packages
    steps:
      - uses: actions/checkout@v4
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: release-*
          merge-multiple: true
      - name: Set release metadata
        id: release
        run: |
          echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "name=Release ${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
      - name: Create checksums
        run: |
          cd artifacts
          sha256sum * > checksums.txt
      - name: Upload release artifacts
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release.outputs.tag }}
          files: artifacts/*
          fail_on_unmatched_files: true
